on:
  push:
    branches:
      - testadamdeploy

env:
  B2CServicePrincipalClientId: ee7e5f64-2e51-45a3-b4df-54892346c45f
  Name: adamtestadb2c
  Production: false
  Tenant: adamtestadb2c.onmicrosoft.com
  PolicyPrefix: B2C_1A_DEPLOYTEST_
  BasePolicyName: TrustFrameworkBase
  ExtensionsPolicyName: TrustFrameworkExtensions
  DeploymentMode: Development
  DeveloperMode: true
  RestDebugMode: True
  AppInsightsInstrumentationKey: 666351ec-57b2-410d-b1a9-de2dc94da60d
  IdentityExperienceFrameworkAppId: 3e39f6e9-08c6-4864-9723-36e6c6d740ef
  ProxyIdentityExperienceFrameworkAppId: fac6e45c-c1db-4cd8-82fe-c8c8800c512e
  FacebookClientId: 828534884165356
  FacebookClientSecretKeyContainer: B2C_1A_FacebookSecret
  SendGridSendEmailEndpoint: https://api.sendgrid.com/v3/mail/send
  SendGridSenderEmailAddress: no-reply@customemaildomain.adamstoffel.com
  SendGridEmailVerifyTemplateId: d-64b5dc7bf870411687c90ddd1498ce82
  SendGridApiKeySecretContainer: B2C_1A_SendGridApiKey
  SamlSigningCertificateKeyContainer: B2C_1A_SamlIdpCertificate
  SamlIssuer: https://adamtestadb2c.b2clogin.com/adamtestadb2c.onmicrosoft.com/B2C_1A_DEPLOYTEST_signupsignin_saml

jobs:
  build-and-deploy:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    - name: Replace tokens in B2C policies
      uses: cschleiden/replace-tokens@v1.0
      with:
        tokenPrefix: "{Settings:"
        tokenSuffix: "}"
        files: "B2C Policies/*.xml"
    - name: Upload Facebook Client Secret
      uses: azure-ad-b2c/deploy-trustframework-keyset-secret@v1
      with:
        name: ${{ env.FacebookClientSecretKeyContainer }}
        value: ${{ secrets.FacebookClientSecret }}
        tenant: ${{ env.Tenant }}
        clientId: ${{ env.B2CServicePrincipalClientId }}
        clientSecret: ${{ secrets.B2CServicePrincipalClientSecret }}
    - name: Upload SendGrid API Key
      uses: azure-ad-b2c/deploy-trustframework-keyset-secret@v1
      with:
        name: ${{ env.SendGridApiKeySecretContainer }}
        value: ${{ secrets.SendGridApiKey }}
        tenant: ${{ env.Tenant }}
        clientId: ${{ env.B2CServicePrincipalClientId }}
        clientSecret: ${{ secrets.B2CServicePrincipalClientSecret }}
    - name: Generate SAML Signing Certificate
      run: powershell -command "New-SelfSignedCertificate -Subject cn=${{ env.Tenant }} -KeySpec Signature -KeyExportPolicy Exportable -KeyAlgorithm RSA -KeyLength 2048 -CertStoreLocation Cert:\CurrentUser\My | Export-PfxCertificate -FilePath samlcert.pfx -Password (ConvertTo-SecureString -String '${{ secrets.PfxPassword }}' -Force -AsPlainText)"
    - name: Upload SAML Certificate Keyset
      uses: azure-ad-b2c/deploy-trustframework-keyset-certificate@master
      with:
        name: ${{ env.SamlSigningCertificateKeyContainer }}
        file: samlcert.pfx
        password: ${{ secrets.PfxPassword }}
        tenant: ${{ env.Tenant }}
        clientId: ${{ env.B2CServicePrincipalClientId }}
        clientSecret: ${{ secrets.B2CServicePrincipalClientSecret }}
    - name: Upload TrustFrameworkBase Policy
      uses: azure-ad-b2c/deploy-trustframework-policy@v1
      with:
        file: "B2C Policies/TrustFrameworkBase.xml"
        policy: ${{ env.PolicyPrefix }}${{ env.BasePolicyName }}
        tenant: ${{ env.Tenant }}
        clientId: ${{ env.B2CServicePrincipalClientId }}
        clientSecret: ${{ secrets.B2CServicePrincipalClientSecret }}
    - name: Upload TrustFrameworkExtensions Policy
      uses: azure-ad-b2c/deploy-trustframework-policy@v1
      with:
        file: "B2C Policies/TrustFrameworkExtensions.xml"
        policy: ${{ env.PolicyPrefix }}${{ env.ExtensionsPolicyName }}
        tenant: ${{ env.Tenant }}
        clientId: ${{ env.B2CServicePrincipalClientId }}
        clientSecret: ${{ secrets.B2CServicePrincipalClientSecret }}
    - name: Upload SignUpOrSignin Policy
      uses: azure-ad-b2c/deploy-trustframework-policy@v1
      with:
        file: "B2C Policies/SignUpOrSignin.xml"
        policy: ${{ env.PolicyPrefix }}signupsignin
        tenant: ${{ env.Tenant }}
        clientId: ${{ env.B2CServicePrincipalClientId }}
        clientSecret: ${{ secrets.B2CServicePrincipalClientSecret }}
    - name: Upload SignUpOrSigninSaml Policy
      uses: azure-ad-b2c/deploy-trustframework-policy@v1
      with:
        file: "B2C Policies/SignUpOrSigninSaml.xml"
        policy: ${{ env.PolicyPrefix }}signupsignin_saml
        tenant: ${{ env.Tenant }}
        clientId: ${{ env.B2CServicePrincipalClientId }}
        clientSecret: ${{ secrets.B2CServicePrincipalClientSecret }}

